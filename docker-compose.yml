services:
  ssh-tunnel:
    build: .
    container_name: multi-ssh-tunnel
    restart: unless-stopped
    ports:
      - "25672:25672"     # RabbitMQ 管理界面
      - "28848:28848"     # Nacos http API 端口
      - "23307:23307"     # MySQL (SSH隧道监听23307)
      # ... 按需增加端口和TUNNEL_CONFIG配置
    environment:
      - BASTION_HOST=${SSH_HOST}         # 堡垒机地址
      - SSH_PORT=${SSH_PORT:-22}         # 堡垒机SSH端口
      - SSH_USER=${SSH_USER}             # 堡垒机用户名
      - SSH_PASSWORD=${SSH_PASSWORD}     # 堡垒机密码（从环境变量获取）
      - >-
        TUNNEL_CONFIG=
        25672:10.113.135.23:15672,
        28848:10.113.135.23:8848,
        23307:10.113.132.110:3306
    volumes:
      - ./ssh_key:/root/.ssh
    # 健康检查 - 检查SSH进程是否运行
    healthcheck:
      test: ["CMD", "pgrep", "-f", "autossh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
